"""
рд╢рд┐рдХреНрд╖рдХ рд╕рд╣рд╛рдпрдХ тАФ AI Chatbot Route (Hindi + English)
POST /chat/ask тАФ AI chatbot for Bihar Board teachers
"""
import os
from dotenv import load_dotenv
from fastapi import APIRouter
from pydantic import BaseModel
from openai import AzureOpenAI

router = APIRouter(prefix="/chat", tags=["рдЪреИрдЯрдмреЙрдЯ (Chatbot)"])

SYSTEM_PROMPT = """рдЖрдк рдмрд┐рд╣рд╛рд░ рдмреЛрд░реНрдб рдХреЗ рд╕рд░рдХрд╛рд░реА рд╡рд┐рджреНрдпрд╛рд▓рдпреЛрдВ рдХреЗ рд▓рд┐рдП AI рд╢рд┐рдХреНрд╖рдХ рд╕рд╣рд╛рдпрдХ рд╣реИрдВред

рд╡рд┐рд╢реЗрд╖рдЬреНрдЮрддрд╛:
- рдХрдХреНрд╖рд╛ 1-8 (рд╣рд┐рдВрджреА, рдЕрдВрдЧреНрд░реЗрдЬрд╝реА, рдЧрдгрд┐рдд, рд╡рд┐рдЬреНрдЮрд╛рди, рд╕рд╛рдорд╛рдЬрд┐рдХ рд╡рд┐рдЬреНрдЮрд╛рди, рд╕рдВрд╕реНрдХреГрдд)
- NCERT рдПрд╡рдВ рдмрд┐рд╣рд╛рд░ рдмреЛрд░реНрдб рдкрд╛рдареНрдпрдХреНрд░рдо
- рд╢рд┐рдХреНрд╖рдг рд╡рд┐рдзрд┐рдпрд╛рдБ, рдХрдХреНрд╖рд╛ рдкреНрд░рдмрдВрдзрди
- SCERT Bihar рджрд┐рд╢рд╛рдирд┐рд░реНрджреЗрд╢

TLM (Teaching Learning Materials):
TLM рд╡реЗ рд╢реИрдХреНрд╖рдгрд┐рдХ рд╕рдВрд╕рд╛рдзрди рд╣реИрдВ рдЬреЛ рд╢рд┐рдХреНрд╖рдг рдХреЛ рд░реЛрдЪрдХ, рдкреНрд░рднрд╛рд╡реА рдФрд░ рдЕрдиреБрднрд╡рд╛рддреНрдордХ рдмрдирд╛рддреЗ рд╣реИрдВред рдпреЗ рд░рдЯрдиреЗ рдХреА рдмрдЬрд╛рдп рд╕рдордЭ рдЖрдзрд╛рд░рд┐рдд рдЕрдзрд┐рдЧрдо рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрддреЗ рд╣реИрдВред

рдореБрдЦреНрдп рдкрд╣рд▓реВ:
- рдкрд░рд┐рднрд╛рд╖рд╛: рдЕрдзрд┐рдЧрдо рдХреЛ рд╕рд╣рдпреЛрдЧ рджреЗрдиреЗ рд╡рд╛рд▓реЗ рдЙрдкрдХрд░рдг (Instructional Aids)
- рдкреНрд░рдХрд╛рд░:
  тАв Visual: рдЪрд╛рд░реНрдЯ, рдлреНрд▓реИрд╢рдХрд╛рд░реНрдб, рдкреЛрд╕реНрдЯрд░, рдорд╛рдирдЪрд┐рддреНрд░, рдЪрд┐рддреНрд░
  тАв Audio: рд░реЗрдбрд┐рдпреЛ, рдСрдбрд┐рдпреЛ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ
  тАв Audio-Visual: рд╡реАрдбрд┐рдпреЛ, рдПрдиреАрдореЗрд╢рди
  тАв Kinesthetic/Concrete: рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╡рд╕реНрддреБрдПрдБ, рдореЙрдбрд▓, рдорд┐рдЯреНрдЯреА, рдмреНрд▓реЙрдХ, рдкрдЬрд╝рд▓
- рдЙрджреНрджреЗрд╢реНрдп: рд╕рдордЭ рдмрдврд╝рд╛рдирд╛, рд╕рд╣рднрд╛рдЧрд┐рддрд╛ рдмрдврд╝рд╛рдирд╛, рд╕реНрдорд░рдг рд╢рдХреНрддрд┐ рдордЬрдмреВрдд рдХрд░рдирд╛
- рдЪрдпрди рдорд╛рдирджрдВрдб: рд╕реНрдерд╛рдиреАрдп, рд╕рд╛рдВрд╕реНрдХреГрддрд┐рдХ рд░реВрдк рд╕реЗ рдкрд░рд┐рдЪрд┐рдд, рдЖрдпреБ-рдЙрдкрдпреБрдХреНрдд, рдЙрджреНрджреЗрд╢реНрдп-рдЖрдзрд╛рд░рд┐рдд
- рдорд╣рддреНрд╡: рдЕрдореВрд░реНрдд рдЕрд╡рдзрд╛рд░рдгрд╛рдУрдВ рдХреЛ рдареЛрд╕ рдЕрдиреБрднрд╡ рд╕реЗ рдЬреЛрдбрд╝рдирд╛
- рд╕рд╛рд╡рдзрд╛рдиреА: TLM рдХрд╛ рд╕рдВрддреБрд▓рд┐рдд рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ; рдЕрддрд┐ рдирд┐рд░реНрднрд░рддрд╛ рд╕реЗ рддрд╛рд░реНрдХрд┐рдХ рд╕реЛрдЪ рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛ рд╕рдХрддреА рд╣реИ

рд╢рд┐рдХреНрд╖рдг рджреГрд╖реНрдЯрд┐рдХреЛрдг:
- Learning by Doing рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрдВ
- рдХрдо/рд╢реВрдиреНрдп рд▓рд╛рдЧрдд рд╕реНрдерд╛рдиреАрдп рд╕рд╛рдордЧреНрд░реА (рдЕрдкрд╢рд┐рд╖реНрдЯ, рдЧрддреНрддрд╛, рдкрддреНрддрд┐рдпрд╛рдБ рдЖрджрд┐) рдХрд╛ рдЙрдкрдпреЛрдЧ
- рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдЧрддрд┐рд╡рд┐рдзрд┐рдпрд╛рдБ (рд╡рд░реНрдб рдмрд┐рдВрдЧреЛ, рдореИрдереЛрдмреЛрд▓рд╛, рд░реЛрд▓-рдкреНрд▓реЗ, рд╕рдореВрд╣ рдХрд╛рд░реНрдп)

SCERT Bihar тАУ Project Based Learning (PBL):
- рдХрдХреНрд╖рд╛ 6-8 рдореЗрдВ рдЧрдгрд┐рдд рдПрд╡рдВ рд╡рд┐рдЬреНрдЮрд╛рди (рдЕрдиреНрдп рд╡рд┐рд╖рдпреЛрдВ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░)
- рдЙрджреНрджреЗрд╢реНрдп: рд░рдЪрдирд╛рддреНрдордХрддрд╛, рд╕рдорд╕реНрдпрд╛ рд╕рдорд╛рдзрд╛рди, рддрд╛рд░реНрдХрд┐рдХ рдХреНрд╖рдорддрд╛ рд╡рд┐рдХрд╛рд╕
- 24 рд╕рдВрд░рдЪрд┐рдд рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕
- 5-рджрд┐рд╡рд╕реАрдп рд╢рд┐рдХреНрд╖рдХ рд╣реИрдВрдбрдмреБрдХ (DIKSHA рдРрдк рдкрд░ рдЙрдкрд▓рдмреНрдз)
- рдЬрд┐рд▓рд╛/рд░рд╛рдЬреНрдп рд╕реНрддрд░ рдкрд░ PBL рдореЗрд▓рд╛
- рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЬреАрд╡рди рдЖрдзрд╛рд░рд┐рдд рдЧрддрд┐рд╡рд┐рдзрд┐рдпрд╛рдБ

рдирд┐рдпрдо:
1. рдкреНрд░рд╢реНрди рд╣рд┐рдВрджреА рдореЗрдВ рд╣реЛ рддреЛ рд╣рд┐рдВрджреА рдореЗрдВ рдЙрддреНрддрд░ рджреЗрдВ; рдЕрдВрдЧреНрд░реЗрдЬрд╝реА рдореЗрдВ рд╣реЛ рддреЛ рдЕрдВрдЧреНрд░реЗрдЬрд╝реА рдореЗрдВ
2. рдЙрддреНрддрд░ 200-400 рд╢рдмреНрджреЛрдВ рдореЗрдВ, рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ
3. рдмреБрд▓реЗрдЯ рдкреЙрдЗрдВрдЯ рд╡ рдЫреЛрдЯреЗ рд╡рд╛рдХреНрдп рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВ
4. рдХрдХреНрд╖рд╛-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдПрд╡рдВ рд╡рд┐рд╖рдп-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрддреНрддрд░ рджреЗрдВ
5. рд╡реНрдпрд╡рд╣рд╛рд░рд┐рдХ рд╢рд┐рдХреНрд╖рдг рд╕реБрдЭрд╛рд╡ рдЕрдирд┐рд╡рд╛рд░реНрдп
6. рд╕рджреИрд╡ Markdown (##, **, -, рдЖрджрд┐) рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВред

рдЙрддреНрддрд░ рдХрд╛ рдЕрдирд┐рд╡рд╛рд░реНрдп Markdown рдкреНрд░рд╛рд░реВрдк (Emojis рдХреЗ рд╕рд╛рде):
## ЁЯУЪ рд╡рд┐рд╖рдп: [рдкрд╛рда рдХрд╛ рдирд╛рдо]

### ЁЯОп рдореБрдЦреНрдп рдмрд┐рдВрджреБ
- 
- 

### ЁЯТб рд╢рд┐рдХреНрд╖рдг рд╕реБрдЭрд╛рд╡
- 
- 

### ЁЯЫая╕П TLM рдЙрдкрдпреЛрдЧ
- **Visual:** ...
- **Kinesthetic (рд╕реНрдерд╛рдиреАрдп/рдХрдо рд▓рд╛рдЧрдд):** ...

### ЁЯУЭ рдЕрднреНрдпрд╛рд╕ / рдЧрддрд┐рд╡рд┐рдзрд┐
- **рдЧрддрд┐рд╡рд┐рдзрд┐ 1:** ...
- **рдЧреГрд╣рдХрд╛рд░реНрдп:** ...
"""

class ChatRequest(BaseModel):
    message: str
    history: list = []


class ChatResponse(BaseModel):
    reply: str
    error: str = None


@router.post("/ask", response_model=ChatResponse)
async def chat_ask(req: ChatRequest):
    """AI chatbot тАФ ask any teaching question (Hindi/English)."""
    endpoint = os.getenv("AZURE_OPENAI_ENDPOINT", "").strip('"').strip("'")
    api_key = os.getenv("AZURE_OPENAI_API_KEY", "").strip('"').strip("'")
    deployment = os.getenv("AZURE_OPENAI_DEPLOYMENT_NAME", "gpt-5-mini").strip('"').strip("'")
    api_version = os.getenv("AZURE_OPENAI_API_VERSION", "2024-12-01-preview").strip('"').strip("'")

    if not endpoint or not api_key:
        load_dotenv(os.path.join(os.path.dirname(__file__), "..", "..", ".env"))
        endpoint = os.getenv("AZURE_OPENAI_ENDPOINT", "").strip('"').strip("'")
        api_key = os.getenv("AZURE_OPENAI_API_KEY", "").strip('"').strip("'")
        
    if not endpoint or not api_key:
        return ChatResponse(reply="", error="Azure OpenAI credentials not configured")

    try:
        client = AzureOpenAI(
            azure_endpoint=endpoint, api_key=api_key, api_version=api_version,
        )
        messages = [{"role": "system", "content": SYSTEM_PROMPT}]
        for msg in req.history[-10:]:
            messages.append({"role": msg.get("role", "user"), "content": msg.get("content", "")})
        messages.append({"role": "user", "content": req.message})

        response = client.chat.completions.create(
            model=deployment, messages=messages, max_completion_tokens=3000,
        )
        reply = response.choices[0].message.content
        if not reply:
            choice = response.choices[0]
            if hasattr(choice.message, "refusal") and choice.message.refusal:
                reply = f"AI рдиреЗ рдЙрддреНрддрд░ рджреЗрдиреЗ рд╕реЗ рдордирд╛ рдХрд┐рдпрд╛: {choice.message.refusal}"
            else:
                reply = "тЪая╕П AI рдиреЗ рдЦрд╛рд▓реА рдЙрддреНрддрд░ рджрд┐рдпрд╛ред рдХреГрдкрдпрд╛ рд╕рд░рд▓ рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВред"
        return ChatResponse(reply=reply)
    except Exception as e:
        return ChatResponse(reply="", error=f"AI рд╕реЗрд╡рд╛ рддреНрд░реБрдЯрд┐: {str(e)}")
